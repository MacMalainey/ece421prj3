\documentclass{article}
\usepackage[utf8]{inputenc}
\usepackage{minted}

\title{ECE 421 Project 3 Design}
\author{
  Mackenzie Malainey\\
  \texttt{mmalaine@ualberta.ca}
  \and
  Lora Ma\\
  \texttt{lora@ualberta.ca}
  \and
  Benjamin Kong\\
  \texttt{bkong@ualberta.ca}
}
\date{April 2022}

\begin{document}

\begin{titlepage}
    \maketitle
    \tableofcontents
\end{titlepage}

\section{Backend API}

\subsection{REST Endpoints}

\subsubsection{User Authentication}

\begin{description}
  \item[POST] \mintinline{text}|/api/v0/user/login/|
  \begin{description}
    \item[Description] \hfill \\
    Logs in a user.
    \item[Request Body Format] \hfill \\
    Form Data
    \item[Request Body Data] \hfill \\
    \mintinline{text}{user_id = USER_PROVIDED_USERNAME} \\
    \mintinline{text}{password = USER_PROVIDED_RAW_PASSWORD}
    \item[Response Cookies] \hfill \\
    ADD \mintinline{text}{user_auth_token}
    \item[Response Status] \hfill \\
    200 - If successful \\
    401 - If \mintinline{text}{user_id} and \mintinline{text}{password} do match an existing user \\
    404 - If request body is malformed % CHECK IF TRUE, IF IT IS WE SHOULD CHANGE THE RETURN TYPE
    \item[Known Issues] 
    \item Attempting to log in to another account when already logged will automatically log out the other user from the server's perspective.
    However this might pose a security concern (especially if user specific data gets cached in the future)
    \item Currently accepts and processes requests without any method of form encryption (dangerously insecure)
  \end{description}

  \item[POST] \mintinline{text}|/api/v0/user/logout/|
  \begin{description}
    \item[Description] \hfill \\
    Logs out the currently logged in user.
    \item[Request Cookies] \hfill \\
    CONTAINS \mintinline{text}{user_auth_token}
    \item[Response Cookies] \hfill \\
    CLEAR \mintinline{text}{user_auth_token}
    \item[Response Status] \hfill \\
    200 - If successful \\
    404 - If header doesn't contain cookie % CHECK IF TRUE, IF IT IS WE SHOULD CHANGE THE RETURN TYPE
    \item[Known Issues] 
    \item Need to verify this removes the cookie in browser
  \end{description}

  \pagebreak
  \item[POST] \mintinline{text}|/api/v0/user/register/|
  \begin{description}
    \item[Description] \hfill \\
    Registers a new user.
    \item[Request Body Format] \hfill \\
    Form Data
    \item[Request Body Data] \hfill \\
    \mintinline{text}{user_id = USER_PROVIDED_USERNAME} \\
    \mintinline{text}{password = USER_PROVIDED_RAW_PASSWORD}
    \item[Response Cookies] \hfill \\
    ADD \mintinline{text}{user_auth_token}
    \item[Response Status] \hfill \\
    200 - If \mintinline{text}{user_id} and \mintinline{text}{password} match an existing user \\
    401 - If \mintinline{text}{user_id} and \mintinline{text}{password} do match an existing user \\
    404 - If request body is malformed % CHECK IF TRUE, IF IT IS WE SHOULD CHANGE THE RETURN TYPE
    \item[Response Cookies] \hfill \\
    ADD \mintinline{text}{user_auth_token}
    \item[Response Status] \hfill \\
    200 - If \mintinline{text}{user_id} and \mintinline{text}{password} match an existing user \\
    404 - If header doesn't contain cookie % CHECK IF TRUE, IF IT IS WE SHOULD CHANGE THE RETURN TYPE
    \item[Known Issues] 
    \item Attempting to log in to another account when already logged will automatically log out the other user from the server's perspective.
    However this might pose a security concern (especially if user specific data gets cached in the future)
    \item Currently accepts and processes requests without any method of form encryption (dangerously insecure)
    \item Assumes client enforces proper password requirements
  \end{description}
\end{description}

\pagebreak

\subsubsection{Match Records}

\begin{description}
  \item[POST] \mintinline{text}|/api/v0/user/records/add|
  \begin{description}
    \item[Description] \hfill \\
    Registers match data for the current user
    \item[Request Body Format] \hfill \\
    JSON
    \item[Request Body Data] \hfill
    \begin{minted}{js}
"start_time": START_TIME_IN_SECONDS_FROM_EPOCH_UTC_TIME,
"game_id": {"Connect4", "OttoToot"},
"cpu_level": {"Easy", "Medium", "Hard"},
"duration": DURATION_IN_SECONDS,
"result": {"Win", "Loss", "Tie"}
    \end{minted}
    \item[Request Cookies] \hfill \\
    CONTAINS \mintinline{text}{user_auth_token}
    \item[Response Status] \hfill \\
    200 - If successful \\
    401 - If \mintinline{text}{user_auth_token} does match an existing user \\
    404 - If request body is malformed % CHECK IF TRUE, IF IT IS WE SHOULD CHANGE THE RETURN STATUS
    \item[Known Issues] 
    \item Does not verify \mintinline{js}|"start_time"|.  Probably best to remove this field and use server time to log time upon recording.
  \end{description}

  \item[GET] \mintinline{text}|/api/v0/user/records|
  \begin{description}
    \item[Description] \hfill \\
    Retrieves all the match data from the current user sorted by most recent matches first
    \item[Request Cookies] \hfill \\
    CONTAINS \mintinline{text}{user_auth_token}
    \item[Optional Request Query Parameters] \hfill \\
    \mintinline{text}|limit (default = 10)| \\
    Number of records to return at once \vspace{0.5em} \\
    \mintinline{text}|offset (default = 0)| \\
    Number of records to skip (for pagination)
    \item[Response Status] \hfill \\
    200 - If successful \\
    404 - If header doesn't contain cookie % CHECK IF TRUE, IF IT IS WE SHOULD CHANGE THE RETURN TYPE
    \item[Known Issues] 
    \item Does not support any form of filtering or sorting other than listed
    \item Handles case where user doesn't exist by returning empty list instead of an error status
    \item Does not apply a maximum or minimum on limit values
    \item Should include a count of how many records there are in total
  \end{description}

  \item[GET] \mintinline{text}|/api/v0/games/records|
  \begin{description}
    \item[Description] \hfill \\
    Retrieves all the match data from the current user sorted by most recent matches first
    \item[Request Cookies] \hfill \\
    CONTAINS \mintinline{text}{user_auth_token}
    \item[Optional Request Query Parameters] \hfill \\
    \mintinline{text}|limit (default = 10)| \\
    Number of records to return at once \vspace{0.5em} \\
    \mintinline{text}|offset (default = 0)| \\
    Number of records to skip (for pagination) \vspace{0.5em} \\
    \mintinline{text}|before| \\
    Returns matches that happened before (UTC timestamp in seconds) \vspace{0.5em} \\
    \mintinline{text}|after| \\
    Returns matches that happened after (UTC timestamp in seconds) \vspace{0.5em} \\
    \mintinline{text}|sort_by (default = starttime)| \\
    Value to sort by, can be either \mintinline{text}{duration} or \mintinline{text}{starttime} \vspace{0.5em} \\
    \mintinline{text}|asc| \\
    Sort direction, defaults to false unless using \mintinline{text}{sort_by=duration} \vspace{0.5em} \\
    \mintinline{text}|filter| \\
    Only returns elements that match the filter specification (see examples for more info)
    \item[Response Status] \hfill \\
    200 - If successful
    \item[Known Issues] 
    \item Does not have max and min values for \mintinline{text}{limit}
    \item Should include a count of how many records there are in total
  \end{description}
\end{description}

\subsubsection{Notes for Future Development}

\begin{itemize}
  \item[] Admin User APIs should be implemented so that a web-created Admin Console may be implemented.
  This was not implemented right now due to time constraints.
  \item[] Check APIs for security vulnerabilities (due to time constaints only minimal security could be implemented)
\end{itemize}

\subsection{Backend Stack}

The backend is implemented using \mintinline{text}|rocket(v0.5.0)| for the backend server framework. 
Through \mintinline{text}|rocket|'s database connection pool library we used \mintinline{text}|diesel|
as the backend database library which interfaces with a \mintinline{text}|sqlite3| database.

The original design was to use \mintinline{text}|rocket(v0.4.4)| with a \mintinline{text}|mongodb| database through \mintinline{text}|rocket|'s database connection pool library.
This would allow us to carry over the prior project's database with minimal issue.
However we found that some of the dependencies had been removed from \mintinline{text}{crates.io} and therefore were not able to use \mintinline{text}|mongodb| with \mintinline{text}|rocket(v0.4.4)|.
Sadly \mintinline{text}|rocket(v0.5.0)| does not support \mintinline{text}|mongodb| and we decided it was best to not homebrew a solution together.  That is what led us to using \mintinline{text}|diesel|
with a \mintinline{text}|sqlite3| database. We felt \mintinline{text}|diesel| was a better option than \mintinline{text}|rusqlite| with its CLI app to be able to create and run database migrations,
embed migrations into the app so that the database could be built on first run as well as the compile time query checking saving a lot of potential headaches during development and for future development and saved on boilerplate code.

\subsection{Admin CLI}

A local database instance can be investigated directly using \mintinline{text}|prj3_cli|
which allows for actions on the database that are not currently available through the backend API.

\end{document}